{
    "Comment": "Redshift ELT processing workflow for refreshing presentation ADM views",
    "StartAt": "ListExecutions",
    "States": {
        "ListExecutions": {
            "Type": "Task",
            "Next": "ValidateRunningInstances",
            "Parameters": {
                "StateMachineArn.$": "$$.StateMachine.Id",
                "StatusFilter": "RUNNING"
            },
            "Resource": "arn:aws:states:::aws-sdk:sfn:listExecutions",
            "ResultSelector": {
                "runningExecutionsCount.$": "States.ArrayLength($.Executions)"
            }
        },
        "ValidateRunningInstances": {
            "Type": "Choice",
            "Choices": [
                {
                    "Variable": "$.runningExecutionsCount",
                    "NumericGreaterThan": 1,
                    "Next": "RunningInstanceDetected"
                }
            ],
            "Default": "adm_refresh_update_first"
        },
        "RunningInstanceDetected": {
            "Type": "Fail",
            "Error": "RunningInstanceDetected"
        },
        "adm_refresh_update_first": {
            "Comment": "Invoke first ADM Refresh update script",
            "Type": "Task",
            "Resource": "arn:aws:states:::aws-sdk:redshiftdata:executeStatement",
            "ResultPath": "$.sql_output",
            "Parameters": {
                "WorkgroupName": "${RedshiftWorkgroup}",
                "Database": "${RedshiftDatabaseName}",
                "SecretArn": "${RedshiftSecretArn}",
                "Sql": "CALL presentation_refactored.refresh_adm_views_cascade_part_a_test()"
            },
            "Next": "wait_on_adm_refresh_update_first"
        },
        "wait_on_adm_refresh_update_first": {
            "Comment": "Wait before status check",
            "Type": "Wait",
            "Seconds": 300,
            "Next": "refresh_adm_update_first_status_check"
        },
        "refresh_adm_update_first_status_check": {
            "Comment": "Check Task Status",
            "Type": "Task",
            "Resource": "arn:aws:states:::aws-sdk:redshiftdata:describeStatement",
            "ResultPath": "$.sql_output",
            "Parameters": {
                "Id.$": "$.sql_output.Id"
            },
            "Next": "is_adm_refresh_update_first_complete"
        },
        "is_adm_refresh_update_first_complete": {
            "Comment": "check if first ADM Refresh update step is complete",
            "Type": "Choice",
            "Choices": [
                {
                    "Variable": "$.sql_output.Status",
                    "StringEquals": "FAILED",
                    "Next": "adm_refresh_update_failure"
                },
                {
                    "Variable": "$.sql_output.Status",
                    "StringEquals": "FINISHED",
                    "Next": "adm_refresh_update_second"
                }
            ],
            "Default": "wait_on_adm_refresh_update_first"
        },
        "adm_refresh_update_second": {
            "Comment": "Invoke second ADM Refresh update script",
            "Type": "Task",
            "Resource": "arn:aws:states:::aws-sdk:redshiftdata:executeStatement",
            "ResultPath": "$.sql_output",
            "Parameters": {
                "WorkgroupName": "${RedshiftWorkgroup}",
                "Database": "${RedshiftDatabaseName}",
                "SecretArn": "${RedshiftSecretArn}",
                "Sql": "CALL presentation_refactored.refresh_adm_views_cascade_part_b_test()"
            },
            "Next": "wait_on_adm_refresh_update_second"
        },
        "wait_on_adm_refresh_update_second": {
            "Comment": "Wait before status check",
            "Type": "Wait",
            "Seconds": 120,
            "Next": "refresh_adm_update_second_status_check"
        },
        "refresh_adm_update_second_status_check": {
            "Comment": "Check Task Status",
            "Type": "Task",
            "Resource": "arn:aws:states:::aws-sdk:redshiftdata:describeStatement",
            "ResultPath": "$.sql_output",
            "Parameters": {
                "Id.$": "$.sql_output.Id"
            },
            "Next": "is_adm_refresh_update_second_complete"
        },
        "is_adm_refresh_update_second_complete": {
            "Comment": "check if second ADM Refresh update step is complete",
            "Type": "Choice",
            "Choices": [
                {
                    "Variable": "$.sql_output.Status",
                    "StringEquals": "FAILED",
                    "Next": "adm_refresh_update_failure"
                },
                {
                    "Variable": "$.sql_output.Status",
                    "StringEquals": "FINISHED",
                    "Next": "trigger_adm_refresh_v3_step_function"
                }
            ],
            "Default": "wait_on_adm_refresh_update_second"
        },
        "trigger_adm_refresh_v3_step_function": {
            "Type": "Task",
            "Resource": "arn:aws:states:::states:startExecution",
            "Parameters": {
                "StateMachineArn": "${ADMV3RefreshStepFunctionArn}",
                "Input": {
                    "StatePayload": "Triggered from stage to redshift consolidated step function",
                    "AWS_STEP_FUNCTIONS_STARTED_BY_EXECUTION_ID.$": "$$.Execution.Id"
                }
            },
            "Next": "StopProcessing",
            "Retry": [
                {
                    "ErrorEquals": [
                        "States.TaskFailed",
                        "States.Timeout"
                    ],
                    "BackoffRate": 2,
                    "MaxAttempts": 3,
                    "IntervalSeconds": 30
                }
            ]
        },
        "adm_refresh_update_failure": {
            "Type": "Fail",
            "Cause": "Failure within ADM Refresh Update step",
            "Error": "Error"
        },
        "StopProcessing": {
            "Type": "Pass",
            "Result": "pass",
            "End": true
        }
    }
}
